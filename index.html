<!DOCTYPE html>
<html>
    <head>
        <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/manifest.json">
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">

        <link rel="stylesheet" href="style.css?version=2">

        <title>Who Goes First?</title>
    </head>
    <body>
        <h1>Who Goes First?</h1>
        <table id="layoutTable">
                <tr style="vertical-align: top;">
                    <td colspan="6">
                            <p>This is a tool for taking initiative order in Dungeons & Dragons combat.</p>
                            <p>First, the Dungeon Master should create a session using the "Create Session" button. This generates a new session code, which will be displayed below.</p>
                            <p>The players can then enter that session code and the name of their character into the fields under the "Join a Session" section. Press the "Join Session" button to join the session as this character.</p>
                            <p>Players in the session can calculate and enter their initiative score in the form below, then press the "Submit Initiative" button to share their initiative with the rest of the party. The players'
                            initiative scores are displayed in the table at the bottom of this page, ordered from highest to lowest score.</p>
                            <p>The "Nat 20," "Nat 1," and "Modifier" fields are used to adjust the priority of the initiative scores when they are ordered in the table.</p>
                            <ul>
                                <li>"Nat 20" - Check this if the die rolled a natural 20. This adds 20 to the initiative score when sorting the initiative table.</li>
                                <li>"Nat 1" - Check this if the die rolled a natural 1. This subtracts 20 from the initiative score when sorting the initiative table.</li>
                                <li>"Modifier" - Enter your character's dexterity/initiative modifier here. If two players submit the same initiative score, the player with the greater modifier is given priority when sorting the table.</li>
                            </ul>
                            <p>If you are a Dungeon Master and did not create the session or need to re-join the session, use the "Join a Session" section with the session code and a random character name. This name will not appear in the initiatives
                                table unless you press the "Submit Initiative" button.
                            </p>
                    </td>
                </tr>
            <tr style="vertical-align: top;">
                <td style="width: 30%;">
                    <form id="createForm">
                        <h2 class="shiny">Create a Session</h2>
                        <input type="submit" id="createButton" value="Create Session" class="shiny">
                    </form>
                </td>
                <td>
                    <form id="joinForm">
                        <h2 class="shiny">Join a Session</h2>
                        <table>
                            <tr>
                                <td>
                                    Session Code: 
                                </td>
                                <td>
                                    <input type="text" name="sessionCode" id="sessionCodeInput" value="" onChange="validateInputs();">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Character Name:
                                </td>
                                <td>
                                    <input type="text" name="characterName" id="characterNameInput" value="" onChange="validateInputs();">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <input type="submit" id="joinButton" value="Join Session" class="shiny">
                                </td>
                            </tr>
                        </table>
                    </form>
                </td>
            </tr>
            <tr style="vertical-align: middle;">
                <td style="background: none; text-align: right;"><h3>Session Code: </h3>
                    <i>Share this with your party</i>
                </td>
                <td style="text-align: center;">    
                    <a id="sessionCodeLink"><h1 id="sessionCodeLabel"> _ _ _ _ _ _</h1></a>
                </td>
            </tr>
            <tr>
                <td colspan="6">
                    <hr>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <form id="initiativeForm">
                        <table>
                            <tr style="vertical-align: top;">
                                <td style="width: 20%;">
                                    <h2>My Initiative: </h2>
                                </td>
                                <td colspan="4">
                                    <input type="number" name="initiative" id="initiativeInput" value="0" style="font-size: 2em;">
                                    <i>(After applying all modifiers)</i>
                                </td>
                            </tr>
                            <tr style="text-align: left;">
                                <td style="text-align: right;">
                                    <b>Nat 20 (Critical):</b>
                                </td>
                                <td style="width: 10%;">
                                    <input type="checkbox" name="crit" id="critInput" value="false">
                                </td>
                                <td style="text-align: right;">
                                    <b>Nat 1 (Suprised):</b>
                                </td>
                                <td style="width: 10%;">
                                    <input type="checkbox" name="fail" id="failInput" value="false">
                                </td>
                                <td></td>
                            </tr>
                            <tr style="vertical-align: middle;">
                                    <td>&nbsp;</td>
                                    <td style="width: 20%;">
                                        <h4>Modifier (Dex): </h4>
                                    </td>
                                    <td colspan="2">
                                        <input type="number" name="modifier" id="modifierInput" value="0">
                                        <i>(This is used to determine who goes first in a tie)</i>
                                    </td>
                                    <td>&nbsp;</td>
                                </tr>
                            <tr>
                                <td colspan="5">
                                    <hr>
                                    <input type="submit" id="initiativeButton" value="Submit Initiative" class="shiny">
                                </td>
                            </tr>
                        </table>
                    </form>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <h2>Initiative Order</h2>
                    <table id="initiative-table">
                        <tr style="font-size: 1.2em;">
                            <th style="width: 3em;">#</th>
                            <th>Name</th>
                            <th>Initiative</th>
                            <th>Critical</th>
                            <th>Surprised</th>
                            <th>Modifier</th>
                        </tr>
                        <tr>
                            <td colspan="6"><i>No initiatives have been submitted yet</i></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>

        <script src="js/initiative_api.js?version=2"></script>
        <script src="js/initiative_ui.js?version=2"></script>
        <script>
            function validateInputs() {
                let nameIn = document.getElementById('characterNameInput').value;
                let codeIn = document.getElementById('sessionCodeInput').value;
                document.getElementById('joinButton').disabled = nameIn.length == 0 || codeIn.length !== 6;
            }

            function validateConnection() {
                document.getElementById('initiativeButton').disabled == socket.readyState !== WebSocket.OPEN;
            }

            function sessionParams() {
                let session = document.getElementById("sessionCodeInput").value;
                let name = document.getElementById("characterNameInput").value;
                return {
                    session: session,
                    name: name
                }
            }
            function submitCreate() {
                createSession();
            }
            function submitJoin() {
                let params = sessionParams();
                joinSession(params.session, params.name);
            }
            function submitInitiative() {
                sendInitiative({ 
                    initiative: document.getElementById("initiativeInput").value,
                    critical: document.getElementById("critInput").checked,
                    surprised: document.getElementById("failInput").checked,
                    modifier: document.getElementById("modifierInput").value
                });
            }
            document.getElementById("createForm").onsubmit = function(event) {
                event.preventDefault();
                submitCreate();
                return false;
            }
            document.getElementById("joinForm").onsubmit = function(event) {
                event.preventDefault();
                submitJoin();
                return false;
            }
            document.getElementById("initiativeForm").onsubmit = function(event) {
                event.preventDefault();
                submitInitiative();
                return false;
            }

            // get parameters from query string
            let urlParams = new URLSearchParams(window.location.search);
            console.log(JSON.stringify(urlParams));
            if (urlParams.has('code'))
                sessionCode = urlParams.get('code');
            if (urlParams.has('name'))
                characterName = urlParams.get('name');
            document.getElementById('sessionCodeInput').value = sessionCode;
            document.getElementById('characterNameInput').value = characterName;
            document.getElementById('modifierInput').value = Number(getCookie('modifier')) || 0;

            if (urlParams.has('code') && urlParams.get('code') == sessionCode  && (characterName.length || 0) > 1) {
                showSessionCode(sessionCode);
                submitJoin();
                console.log('automatically joining session ' + sessionCode);
            }

            validateInputs();
            validateConnection();
        </script>
    </body>
</html>